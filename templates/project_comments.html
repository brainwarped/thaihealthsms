{% extends 'base.html' %}
{% load interface_tags i18n helper %}

{% block post_comment_ajax_callback %}{% endblock %}

{% block html_head %}
<script type="text/javascript">
$(document).ready(function() {
	bindCommentBox($(".post-project-comment"));

	$("#reply-comment-dialog button").click(function(e) {
		e.preventDefault();
		var message = $("#reply-comment-dialog textarea").val();
		var comment_id = $("#reply-comment-dialog #comment-id").val();
		
		if(message != "") {
			$("#reply-comment-dialog .loading").show();
			$.post("/reply-comment/" + comment_id + "/", {'message': message}, function(data) {
				$("#reply-comment-dialog .loading").hide();
				$.fn.colorbox.close();
			}, "json");
		}
	});

	$(".reply-comment").colorbox({width:"50%", scrolling:false, opacity:0.4, inline:true, href:"#reply-comment-dialog", 
		onOpen:function(){
			$("#reply-comment-dialog").css("display", "block");
			$("#reply-comment-dialog textarea").val("");
			$("#reply-comment-dialog #comment-id").val($(this).attr("id").substring(8));
			$("#reply-comment-dialog .loading").hide();
			
			$("#reply-comment-receivers_feed").css("width", "auto");
		},
		onComplete:function(){ $("#reply-comment-dialog textarea").focus(); },
		onCleanup:function() {
			$("#reply-comment-dialog").css("display", "none");
		}
	});
});
</script>
{% endblock %}

{% block body_title %}
<div class="ss_header">
<div class="container">
	{% print_project_header project %}
</div>
</div>
<div class="ss_tab_navi">
	<div class="tabs">
		<ul>
			<li><a href="{% url view_project_overview project.id %}">{% trans 'Overview' %}</a></li>
			{% if not project.parent_project %}
			<li><a href="{% url view_project_projects project.id %}">{% trans 'Projects' %}</a></li>
			<li><a href="{% url view_project_reports project.id %}">{% trans 'Reports' %}</a></li>
			{% else %}
			<li><a href="{% url view_project_activities project.id %}">{% trans 'Activities' %}</a></li>
			{% endif %}
			<li class="right_item selected"><img src="{{MEDIA_URL}}/images/icon_comments.png" />{% trans 'Comments' %}</li>
		</ul>
		<div class="clear"></div>
	</div>
</div>
{% endblock %}

{% block body_content %}
<div class="comments_page">
	{% if comments %}
	<ul class="comments">
		{% for comment in comments %}
			<li {% if comment.is_read %}class="read"{% endif %}>
				<div class="sender">{{comment.sent_by.first_name}} {{comment.sent_by.last_name}}
					<div class="metadata">
					{% blocktrans with comment.sent_on|thai_date as c_date and comment.sent_on|date:'H:i' as c_time %}Send at {{ c_date }} Time {{ c_time }} o'clock{% endblocktrans %}
					</div>
				</div>
				<p>{{comment.message}}</p>
				<div id="reply-comment-box" class="reply_comment_panel"><a href="#" id="comment-{{ comment.id }}" class="reply-comment">{% trans 'Reply' %}</a></div>
				<div class="receivers">
					<h4>{% trans 'Receivers' %}:</h4>
					<ul>
						{% for receiver in comment.receivers.all %}
							<li>{{receiver.first_name}} {{receiver.last_name}}</li>
						{% endfor %}
					</ul>
				</div>
			</li>
			{% if comment.commentreply_set.all %}
				<div class="indented">
				{% for c in comment.commentreply_set.all %}
					<li class="read">
						<div class="sender">{{ c.sent_by.first_name }} {{ c.sent_by.last_name }}
							<div class="metadata">
							  {% blocktrans with c.sent_on|thai_date as c_date and c.sent_on|date:'H:i' as c_time %}Send at {{ c_date }} Time {{ c_time }} o'clock{% endblocktrans %}
							</div>
						</div>
						<p>{{ c.content }}</p>
					</li>
				{% endfor %}
				</div>
			{% endif %}
		{% endfor %}
	</ul>
	{% else %}
	<div class="ss_no_information">{% trans 'There are no related comment.' %}</div>
	{% endif %}
</div>

<div id="reply-comment-dialog" class="comment_dialog">
<label>{% trans 'Comment' %}</label>
<textarea id="reply-comment-textarea"></textarea>
<input type="hidden" id="comment-id"/>
<input type="hidden" name="comment_target"/>
<div class="button-panel"><button>{% trans 'Send a Comment' %}</button><span class="loading"><img src="{{MEDIA_URL}}/images/loading.gif" />{% trans 'Sending...' %}</span></div>
</div>
{% endblock %}
